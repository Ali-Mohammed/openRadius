version: '3.8'

services:
  # Redis for Session Caching
  radius-redis:
    image: redis:7-alpine
    container_name: radius-redis
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --appendonly yes
    volumes:
      - radius-redis-data:/data
    ports:
      - "6380:6379"
    networks:
      - openradius-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # FreeRADIUS 3.2 Server
  freeradius:
    image: freeradius/freeradius-server:latest
    container_name: freeradius
    ports:
      - "1812:1812/udp"  # Authentication
      - "1813:1813/udp"  # Accounting
      - "18120:18120"    # Status server
    volumes:
      - ./config/radiusd.conf:/etc/freeradius/radiusd.conf
      - ./config/clients.conf:/etc/freeradius/clients.conf
      - ./config/mods-available/sql:/etc/freeradius/mods-available/sql
      - ./config/mods-enabled/sql:/etc/freeradius/mods-enabled/sql
      - ./config/mods-available/redis:/etc/freeradius/mods-available/redis
      - ./config/mods-enabled/redis:/etc/freeradius/mods-enabled/redis
      - ./config/sites-available/default:/etc/freeradius/sites-available/default
      - ./config/sites-enabled/default:/etc/freeradius/sites-enabled/default
      - ./config/dictionary:/etc/freeradius/dictionary
      - ./logs:/var/log/radius
    networks:
      - openradius-network
    depends_on:
      radius-redis:
        condition: service_healthy
    environment:
      - TZ=UTC
      - RADIUS_DEBUG=yes
    restart: unless-stopped
    command: ["-X"]

networks:
  openradius-network:
    external: true

volumes:
  radius-redis-data:
    driver: local
