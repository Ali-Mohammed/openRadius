# Default FreeRADIUS Virtual Server
# Enterprise ISP Configuration with PostgreSQL and Redis

server default {
    listen {
        type = auth
        ipaddr = *
        port = 1812
        limit {
            max_connections = 256
            lifetime = 0
            idle_timeout = 30
        }
    }

    listen {
        type = acct
        ipaddr = *
        port = 1813
        limit {
            max_connections = 256
            lifetime = 0
            idle_timeout = 30
        }
    }

    # Authorization section
    authorize {
        # Filter username - Commented out to allow realms without dots (e.g., @kt)
        # filter_username

        # Preprocess
        preprocess

        # Query SQL for user credentials
        sql

        # Check group membership
        if (ok || updated) {
            sql
        }

        # Process CHAP if present
        if ("%{%{Packet-Type}:-}" == "Access-Request") {
            chap
        }

        # PAP
        pap
    }

    # Authentication section
    authenticate {
        # PAP authentication
        Auth-Type PAP {
            pap
        }

        # CHAP authentication
        Auth-Type CHAP {
            chap
        }

        # MS-CHAP authentication
        Auth-Type MS-CHAP {
            mschap
        }
    }

    # Pre-accounting
    preacct {
        preprocess
        acct_unique
        suffix
        files
    }

    # Accounting
    accounting {
        # Write to detail file
        detail

        # SQL accounting
        sql

        # Radutmp for simultaneous use check
        radutmp
    }

    # Session section
    session {
        radutmp
    }

    # Post-authentication
    post-auth {
        # SQL post-auth logging
        sql

        # Post-Auth-Type REJECT
        Post-Auth-Type REJECT {
            # Log rejected attempts
            sql
            attr_filter.access_reject
        }

        # Update reply with session timeouts
        update reply {
            &Session-Timeout := 86400
            &Idle-Timeout := 3600
        }
    }

    # Pre-proxy (if using proxy)
    pre-proxy {
        # attr_filter.pre-proxy
    }

    # Post-proxy (if using proxy)
    post-proxy {
        # eap
    }
}
