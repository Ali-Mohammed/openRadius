# ============================================================================
# Fluent Bit Configuration - EdgeRuntime
# Enterprise ISP Accounting Pipeline
#
# Pipeline: FreeRADIUS (linelog JSON) → Fluent Bit (tail) → ClickHouse (HTTP)
# Also: FreeRADIUS (postauth JSON) → Fluent Bit (tail) → ClickHouse (HTTP)
# ============================================================================

[SERVICE]
    Flush               5
    Daemon              Off
    Log_Level           ${LOG_LEVEL}
    Parsers_File        /fluent-bit/etc/parsers.conf
    HTTP_Server         On
    HTTP_Listen         0.0.0.0
    HTTP_Port           2020
    Health_Check        On
    HC_Errors_Count     3
    HC_Retry_Failure_Count  3
    HC_Period           30
    # Persistent storage for reliability
    storage.path        /fluent-bit/data/
    storage.sync        normal
    storage.checksum    off
    storage.max_chunks_up  128
    storage.metrics     on

# ============================================================================
# INPUT: Tail FreeRADIUS accounting JSON log
# FreeRADIUS linelog module writes one JSON object per line
# ============================================================================
[INPUT]
    Name                tail
    Tag                 radius.accounting
    Path                /var/log/radius/accounting.json
    Parser              json
    Refresh_Interval    5
    Rotate_Wait         30
    DB                  /fluent-bit/data/acct_tail.db
    DB.locking          true
    Buffer_Max_Size     5MB
    Mem_Buf_Limit       20MB
    Skip_Long_Lines     On
    Skip_Empty_Lines    On
    storage.type        filesystem

# ============================================================================
# INPUT: Tail FreeRADIUS post-auth JSON log
# ============================================================================
[INPUT]
    Name                tail
    Tag                 radius.postauth
    Path                /var/log/radius/postauth.json
    Parser              json
    Refresh_Interval    10
    Rotate_Wait         30
    DB                  /fluent-bit/data/postauth_tail.db
    DB.locking          true
    Buffer_Max_Size     2MB
    Mem_Buf_Limit       10MB
    Skip_Long_Lines     On
    Skip_Empty_Lines    On
    storage.type        filesystem

# ============================================================================
# FILTER: Add edge site metadata to accounting records
# ============================================================================
[FILTER]
    Name                modify
    Match               radius.accounting
    Add                 edge_site_id ${EDGE_SITE_ID}

[FILTER]
    Name                modify
    Match               radius.postauth
    Add                 edge_site_id ${EDGE_SITE_ID}

# ============================================================================
# FILTER: Ensure numeric fields default to 0 (ClickHouse type safety)
# ============================================================================
[FILTER]
    Name                lua
    Match               radius.accounting
    script              /fluent-bit/etc/sanitize.lua
    call                sanitize_accounting

# ============================================================================
# OUTPUT: ClickHouse - Accounting data via HTTP interface
# Uses JSONEachRow format for efficient batch inserts
# ============================================================================
[OUTPUT]
    Name                http
    Match               radius.accounting
    Host                clickhouse
    Port                8123
    URI                 /?user=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&database=${CLICKHOUSE_DB}&query=INSERT+INTO+radius_accounting+FORMAT+JSONEachRow
    Format              json_stream
    Json_date_key       false
    Retry_Limit         10
    tls                 Off
    net.keepalive       On
    net.keepalive_idle_timeout  30

# ============================================================================
# OUTPUT: ClickHouse - Post-auth data via HTTP interface
# ============================================================================
[OUTPUT]
    Name                http
    Match               radius.postauth
    Host                clickhouse
    Port                8123
    URI                 /?user=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&database=${CLICKHOUSE_DB}&query=INSERT+INTO+radius_postauth+FORMAT+JSONEachRow
    Format              json_stream
    Json_date_key       false
    Retry_Limit         10
    tls                 Off
    net.keepalive       On
    net.keepalive_idle_timeout  30

# ============================================================================
# OUTPUT: Stdout for debugging (disable in production by setting LOG_LEVEL=error)
# ============================================================================
[OUTPUT]
    Name                stdout
    Match               radius.*
    Format              json_lines
    Log_Level           debug
