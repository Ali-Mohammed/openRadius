# -*- text -*-
#
# EdgeRuntime PostgreSQL queries.conf
# Customized for CDC-synced RadiusUsers / RadiusNasDevices tables
#
# Based on FreeRADIUS 3.2 default postgresql/queries.conf
# Key changes:
#   - client_query reads from "RadiusNasDevices" (PascalCase, CDC-synced)
#   - authorize_check_query reads from "RadiusUsers" (Cleartext-Password)
#   - authorize_reply_query reads from "RadiusCustomAttributes" (per profile/user)
#   - Accounting and post-auth use standard radacct/radpostauth tables

#auto_escape = yes

#######################################################################
#  Query config:  Username
#######################################################################

sql_user_name = "%{User-Name}"

#######################################################################
#  Query config:  Event-Timestamp
#######################################################################

event_timestamp_epoch = "%{%{integer:Event-Timestamp}:-%l}"
event_timestamp = "TO_TIMESTAMP(${event_timestamp_epoch})"

#######################################################################
#  Query config:  Class attribute
#######################################################################

class {
        column_name =   # ", Class"
        packet_xlat =   # ", '%{Class}'"
        reply_xlat =    # ", '%{reply:Class}'"
}

#######################################################################
#  NAS Client Query - reads from CDC-synced RadiusNasDevices
#######################################################################
#  Columns returned:
#  0. Row ID
#  1. Name (IP address)
#  2. Shortname
#  3. Type
#  4. Secret
#  5. Server
#######################################################################

client_query = "\
        SELECT \"Id\" AS id, \
               \"Nasname\" AS nasname, \
               \"Shortname\" AS shortname, \
               CASE \"Type\" \
                   WHEN 0 THEN 'other' \
                   WHEN 1 THEN 'cisco' \
                   WHEN 2 THEN 'mikrotik' \
                   ELSE 'other' \
               END AS type, \
               \"Secret\" AS secret, \
               \"Server\" AS server \
        FROM \"RadiusNasDevices\" \
        WHERE \"Enabled\" = 1 \
        AND \"IsDeleted\" = false"

#######################################################################
#  Authorization Queries - reads from CDC-synced RadiusUsers
#######################################################################
#  Return data for each row MUST be in this order:
#  0. Row ID (currently unused)
#  1. UserName/GroupName
#  2. Item Attr Name
#  3. Item Attr Value
#  4. Item Attr Operation
#######################################################################

# Check user credentials (Cleartext-Password from RadiusUsers.Password)
authorize_check_query = "\
        SELECT 1 AS id, \
               '%{SQL-User-Name}' AS username, \
               'Cleartext-Password' AS attribute, \
               \"Password\" AS value, \
               ':=' AS op \
        FROM \"RadiusUsers\" \
        WHERE \"Username\" = '%{SQL-User-Name}' \
        AND \"Enabled\" = true \
        AND \"IsDeleted\" = false \
        AND \"Password\" IS NOT NULL \
        AND (\"Expiration\" IS NULL OR \"Expiration\" > NOW()) \
        LIMIT 1"

# Reply attributes from RadiusCustomAttributes (profile-level + user-level)
authorize_reply_query = "\
        SELECT ca.\"Id\" AS id, \
               '%{SQL-User-Name}' AS username, \
               ca.\"AttributeName\" AS attribute, \
               ca.\"AttributeValue\" AS value, \
               ':=' AS op \
        FROM \"RadiusCustomAttributes\" ca \
        INNER JOIN \"RadiusUsers\" ru ON ca.\"RadiusProfileId\" = ru.\"ProfileId\" \
        WHERE ru.\"Username\" = '%{SQL-User-Name}' \
        AND ca.\"Enabled\" = true \
        AND ca.\"IsDeleted\" = false \
        UNION ALL \
        SELECT ca.\"Id\" AS id, \
               '%{SQL-User-Name}' AS username, \
               ca.\"AttributeName\" AS attribute, \
               ca.\"AttributeValue\" AS value, \
               ':=' AS op \
        FROM \"RadiusCustomAttributes\" ca \
        WHERE ca.\"RadiusUserId\" = ( \
            SELECT \"Id\" FROM \"RadiusUsers\" \
            WHERE \"Username\" = '%{SQL-User-Name}' \
        ) \
        AND ca.\"Enabled\" = true \
        AND ca.\"IsDeleted\" = false \
        ORDER BY id"

# Group check/reply queries - use standard FreeRADIUS tables (optional overrides)
authorize_group_check_query = "\
        SELECT id, GroupName, Attribute, Value, op \
        FROM ${groupcheck_table} \
        WHERE GroupName = '%{${group_attribute}}' \
        ORDER BY id"

authorize_group_reply_query = "\
        SELECT id, GroupName, Attribute, Value, op \
        FROM ${groupreply_table} \
        WHERE GroupName = '%{${group_attribute}}' \
        ORDER BY id"

#######################################################################
# Simultaneous Use Checking Queries
#######################################################################

simul_count_query = "\
        SELECT COUNT(*) \
        FROM ${acct_table1} \
        WHERE username = '%{SQL-User-Name}' \
        AND acctstoptime IS NULL"

simul_verify_query = "\
        SELECT radacctid, acctsessionid, username, nasipaddress, \
               nasportid, framedipaddress, callingstationid, framedprotocol \
        FROM ${acct_table1} \
        WHERE username = '%{SQL-User-Name}' \
        AND acctstoptime IS NULL"

#######################################################################
# Group Membership Queries
#######################################################################

group_membership_query = "\
        SELECT GroupName \
        FROM ${usergroup_table} \
        WHERE UserName = '%{SQL-User-Name}' \
        ORDER BY priority"

#######################################################################
# Accounting Queries
#######################################################################

accounting {
        reference = "%{tolower:type.%{%{Acct-Status-Type}:-%{Request-Processing-Stage}}.query}"

        column_list = "\
                acctsessionid, \
                acctuniqueid, \
                username, \
                realm, \
                nasipaddress, \
                nasportid, \
                nasporttype, \
                acctstarttime, \
                acctupdatetime, \
                acctstoptime, \
                acctsessiontime, \
                acctauthentic, \
                connectinfo_start, \
                connectinfo_stop, \
                acctinputoctets, \
                acctoutputoctets, \
                calledstationid, \
                callingstationid, \
                acctterminatecause, \
                servicetype, \
                framedprotocol, \
                framedipaddress \
                ${..class.column_name}"

        type {
                accounting-on {
                        query = "\
                                UPDATE ${....acct_table1} \
                                SET \
                                        acctstoptime = ${....event_timestamp}, \
                                        acctupdatetime = ${....event_timestamp}, \
                                        acctsessiontime = (${....event_timestamp_epoch} \
                                            - EXTRACT(EPOCH FROM(acctstarttime))), \
                                        acctterminatecause = '%{%{Acct-Terminate-Cause}:-NAS-Reboot}' \
                                WHERE acctstoptime IS NULL \
                                AND nasipaddress = '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}' \
                                AND acctstarttime <= ${....event_timestamp}"
                }

                accounting-off {
                        query = "${..accounting-on.query}"
                }

                start {
                        query = "\
                                INSERT INTO ${....acct_table1} \
                                        (${...column_list}) \
                                VALUES(\
                                        '%{Acct-Session-Id}', \
                                        '%{Acct-Unique-Session-Id}', \
                                        '%{SQL-User-Name}', \
                                        NULLIF('%{Realm}', ''), \
                                        '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}', \
                                        NULLIF('%{%{NAS-Port-ID}:-%{NAS-Port}}', ''), \
                                        '%{NAS-Port-Type}', \
                                        ${....event_timestamp}, \
                                        ${....event_timestamp}, \
                                        NULL, \
                                        0, \
                                        '%{Acct-Authentic}', \
                                        '%{Connect-Info}', \
                                        NULL, \
                                        0, \
                                        0, \
                                        '%{Called-Station-Id}', \
                                        '%{Calling-Station-Id}', \
                                        NULL, \
                                        '%{Service-Type}', \
                                        '%{Framed-Protocol}', \
                                        NULLIF('%{Framed-IP-Address}', '')::inet \
                                        ${....class.packet_xlat}) \
                                ON CONFLICT (acctuniqueid) \
                                DO UPDATE \
                                SET \
                                        acctstarttime = ${....event_timestamp}, \
                                        acctupdatetime = ${....event_timestamp}, \
                                        connectinfo_start = '%{Connect-Info}' \
                                WHERE ${....acct_table1}.acctuniqueid = '%{Acct-Unique-Session-Id}' \
                                AND ${....acct_table1}.acctstoptime IS NULL"

                        query = "\
                                UPDATE ${....acct_table1} \
                                SET \
                                        acctstarttime = ${....event_timestamp}, \
                                        acctupdatetime = ${....event_timestamp}, \
                                        connectinfo_start = '%{Connect-Info}' \
                                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
                }

                interim-update {
                        query = "\
                                UPDATE ${....acct_table1} \
                                SET \
                                        framedipaddress = NULLIF('%{Framed-IP-Address}', '')::inet, \
                                        acctsessiontime = %{%{Acct-Session-Time}:-NULL}, \
                                        acctinterval = (${....event_timestamp_epoch} \
                                            - EXTRACT(EPOCH FROM (COALESCE(acctupdatetime, acctstarttime)))), \
                                        acctupdatetime = ${....event_timestamp}, \
                                        acctinputoctets = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Input-Octets}:-0}'::bigint), \
                                        acctoutputoctets = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Output-Octets}:-0}'::bigint) \
                                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}' \
                                AND acctstoptime IS NULL"

                        query = "\
                                INSERT INTO ${....acct_table1} \
                                        (${...column_list}) \
                                VALUES(\
                                        '%{Acct-Session-Id}', \
                                        '%{Acct-Unique-Session-Id}', \
                                        '%{SQL-User-Name}', \
                                        NULLIF('%{Realm}', ''), \
                                        '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}', \
                                        NULLIF('%{%{NAS-Port-ID}:-%{NAS-Port}}', ''), \
                                        '%{NAS-Port-Type}', \
                                        TO_TIMESTAMP(${....event_timestamp_epoch} - %{%{Acct-Session-Time}:-0}), \
                                        ${....event_timestamp}, \
                                        NULL, \
                                        %{%{Acct-Session-Time}:-NULL}, \
                                        '%{Acct-Authentic}', \
                                        '%{Connect-Info}', \
                                        NULL, \
                                        (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Input-Octets}:-0}'::bigint), \
                                        (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Output-Octets}:-0}'::bigint), \
                                        '%{Called-Station-Id}', \
                                        '%{Calling-Station-Id}', \
                                        NULL, \
                                        '%{Service-Type}', \
                                        '%{Framed-Protocol}', \
                                        NULLIF('%{Framed-IP-Address}', '')::inet \
                                        ${....class.packet_xlat}) \
                                ON CONFLICT (acctuniqueid) \
                                DO NOTHING"
                }

                stop {
                        query = "\
                                UPDATE ${....acct_table2} \
                                SET \
                                        acctstoptime = ${....event_timestamp}, \
                                        acctupdatetime = ${....event_timestamp}, \
                                        acctsessiontime = COALESCE(%{%{Acct-Session-Time}:-NULL}, \
                                                (${....event_timestamp_epoch} \
                                                    - EXTRACT(EPOCH FROM(acctstarttime)))), \
                                        acctinputoctets = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Input-Octets}:-0}'::bigint), \
                                        acctoutputoctets = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Output-Octets}:-0}'::bigint), \
                                        acctterminatecause = '%{Acct-Terminate-Cause}', \
                                        framedipaddress = NULLIF('%{Framed-IP-Address}', '')::inet, \
                                        connectinfo_stop = '%{Connect-Info}' \
                                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}' \
                                AND acctstoptime IS NULL"

                        query = "\
                                INSERT INTO ${....acct_table1} \
                                        (${...column_list}) \
                                VALUES(\
                                        '%{Acct-Session-Id}', \
                                        '%{Acct-Unique-Session-Id}', \
                                        '%{SQL-User-Name}', \
                                        NULLIF('%{Realm}', ''), \
                                        '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}', \
                                        NULLIF('%{%{NAS-Port-ID}:-%{NAS-Port}}', ''), \
                                        '%{NAS-Port-Type}', \
                                        TO_TIMESTAMP(${....event_timestamp_epoch} - %{%{Acct-Session-Time}:-0}), \
                                        ${....event_timestamp}, \
                                        ${....event_timestamp}, \
                                        NULLIF('%{Acct-Session-Time}', '')::bigint, \
                                        '%{Acct-Authentic}', \
                                        '%{Connect-Info}', \
                                        NULL, \
                                        (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Input-Octets}:-0}'::bigint), \
                                        (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Output-Octets}:-0}'::bigint), \
                                        '%{Called-Station-Id}', \
                                        '%{Calling-Station-Id}', \
                                        '%{Acct-Terminate-Cause}', \
                                        '%{Service-Type}', \
                                        '%{Framed-Protocol}', \
                                        NULLIF('%{Framed-IP-Address}', '')::inet \
                                        ${....class.packet_xlat}) \
                                ON CONFLICT (acctuniqueid) \
                                DO NOTHING"

                        query = "\
                                UPDATE ${....acct_table2} \
                                SET \
                                        acctstoptime = ${....event_timestamp}, \
                                        acctupdatetime = ${....event_timestamp}, \
                                        acctsessiontime = COALESCE(%{%{Acct-Session-Time}:-NULL}, \
                                                (${....event_timestamp_epoch} \
                                                    - EXTRACT(EPOCH FROM(acctstarttime)))), \
                                        acctinputoctets = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Input-Octets}:-0}'::bigint), \
                                        acctoutputoctets = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                                                '%{%{Acct-Output-Octets}:-0}'::bigint), \
                                        acctterminatecause = '%{Acct-Terminate-Cause}', \
                                        framedipaddress = NULLIF('%{Framed-IP-Address}', '')::inet, \
                                        connectinfo_stop = '%{Connect-Info}' \
                                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
                }

                #
                #  No Acct-Status-Type == ignore the packet
                #
                accounting {
                     query = "SELECT true"
                }
        }
}

#######################################################################
# Post-Auth Logging Queries
#######################################################################

post-auth {
        query = "\
                INSERT INTO ${..postauth_table} \
                        (username, pass, reply, authdate ${..class.column_name}) \
                VALUES(\
                        '%{User-Name}', \
                        '%{%{User-Password}:-%{Chap-Password}}', \
                        '%{reply:Packet-Type}', \
                        '%S.%M' \
                        ${..class.reply_xlat})"
}
