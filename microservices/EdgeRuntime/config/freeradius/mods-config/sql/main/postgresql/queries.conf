# -*- text -*-
#
# EdgeRuntime PostgreSQL queries.conf
# Customized for CDC-synced RadiusUsers / RadiusNasDevices tables
#
# Based on FreeRADIUS 3.2 default postgresql/queries.conf
# Key changes:
#   - client_query reads from "RadiusNasDevices" (PascalCase, CDC-synced)
#   - authorize_check_query reads from "RadiusUsers" (Cleartext-Password)
#   - authorize_reply_query reads from "RadiusCustomAttributes" (per profile/user)
#   - Accounting REMOVED — all accounting goes to ClickHouse via linelog/Fluent Bit
#   - Post-auth uses standard radpostauth table

#auto_escape = yes

#######################################################################
#  Query config:  Username
#######################################################################

sql_user_name = "%{User-Name}"

#######################################################################
#  Query config:  Event-Timestamp
#######################################################################

event_timestamp_epoch = "%{%{integer:Event-Timestamp}:-%l}"
event_timestamp = "TO_TIMESTAMP(${event_timestamp_epoch})"

#######################################################################
#  Query config:  Class attribute
#######################################################################

class {
        column_name =   # ", Class"
        packet_xlat =   # ", '%{Class}'"
        reply_xlat =    # ", '%{reply:Class}'"
}

#######################################################################
#  NAS Client Query - reads from CDC-synced RadiusNasDevices
#######################################################################
#  Columns returned:
#  0. Row ID
#  1. Name (IP address)
#  2. Shortname
#  3. Type
#  4. Secret
#  5. Server
#######################################################################

client_query = "\
        SELECT \"Id\" AS id, \
               \"Nasname\" AS nasname, \
               \"Shortname\" AS shortname, \
               CASE \"Type\" \
                   WHEN 0 THEN 'other' \
                   WHEN 1 THEN 'cisco' \
                   WHEN 2 THEN 'mikrotik' \
                   ELSE 'other' \
               END AS type, \
               \"Secret\" AS secret, \
               \"Server\" AS server \
        FROM \"RadiusNasDevices\" \
        WHERE \"Enabled\" = 1 \
        AND \"IsDeleted\" = false"

#######################################################################
#  Authorization Queries - reads from CDC-synced RadiusUsers
#######################################################################
#  Return data for each row MUST be in this order:
#  0. Row ID (currently unused)
#  1. UserName/GroupName
#  2. Item Attr Name
#  3. Item Attr Value
#  4. Item Attr Operation
#######################################################################

# Check user credentials (Cleartext-Password + Simultaneous-Use from RadiusUsers)
# Single table scan — unpivots one row into two check attributes
authorize_check_query = "\
        SELECT v.id, \
               '%{SQL-User-Name}' AS username, \
               v.attribute, \
               v.value, \
               ':=' AS op \
        FROM \"RadiusUsers\" u, \
        LATERAL ( VALUES \
            (1, 'Cleartext-Password', u.\"Password\"), \
            (2, 'Simultaneous-Use',   CAST(u.\"SimultaneousSessions\" AS TEXT)) \
        ) AS v(id, attribute, value) \
        WHERE u.\"Username\" = '%{SQL-User-Name}' \
        AND u.\"Enabled\" = true \
        AND u.\"IsDeleted\" = false \
        AND u.\"Password\" IS NOT NULL \
        AND (u.\"Expiration\" IS NULL OR u.\"Expiration\" > NOW()) \
        AND (v.id = 1 OR u.\"SimultaneousSessions\" > 0) \
        LIMIT 2"

# Reply attributes from RadiusCustomAttributes (profile-level + user-level)
authorize_reply_query = "\
        SELECT ca.\"Id\" AS id, \
               '%{SQL-User-Name}' AS username, \
               ca.\"AttributeName\" AS attribute, \
               ca.\"AttributeValue\" AS value, \
               ':=' AS op \
        FROM \"RadiusCustomAttributes\" ca \
        INNER JOIN \"RadiusUsers\" ru ON ca.\"RadiusProfileId\" = ru.\"ProfileId\" \
        WHERE ru.\"Username\" = '%{SQL-User-Name}' \
        AND ca.\"Enabled\" = true \
        AND ca.\"IsDeleted\" = false \
        UNION ALL \
        SELECT ca.\"Id\" AS id, \
               '%{SQL-User-Name}' AS username, \
               ca.\"AttributeName\" AS attribute, \
               ca.\"AttributeValue\" AS value, \
               ':=' AS op \
        FROM \"RadiusCustomAttributes\" ca \
        WHERE ca.\"RadiusUserId\" = ( \
            SELECT \"Id\" FROM \"RadiusUsers\" \
            WHERE \"Username\" = '%{SQL-User-Name}' \
        ) \
        AND ca.\"Enabled\" = true \
        AND ca.\"IsDeleted\" = false \
        ORDER BY id"

# Group check/reply queries - use standard FreeRADIUS tables (optional overrides)
authorize_group_check_query = "\
        SELECT id, GroupName, Attribute, Value, op \
        FROM ${groupcheck_table} \
        WHERE GroupName = '%{${group_attribute}}' \
        ORDER BY id"

authorize_group_reply_query = "\
        SELECT id, GroupName, Attribute, Value, op \
        FROM ${groupreply_table} \
        WHERE GroupName = '%{${group_attribute}}' \
        ORDER BY id"

#######################################################################
# Simultaneous Use Checking Queries
# NOTE: Not used — accounting data is in ClickHouse, not PostgreSQL.
#       Session tracking uses radutmp module instead.
#######################################################################

# simul_count_query - disabled (no radacct table)
# simul_verify_query - disabled (no radacct table)

#######################################################################
# Group Membership Queries
#######################################################################

group_membership_query = "\
        SELECT GroupName \
        FROM ${usergroup_table} \
        WHERE UserName = '%{SQL-User-Name}' \
        ORDER BY priority"

#######################################################################
# Accounting Queries — DISABLED
#######################################################################
# All accounting data goes exclusively to ClickHouse via the
# linelog (JSON) → Fluent Bit → ClickHouse HTTP pipeline.
#
# Benefits of ClickHouse-only accounting:
#   - Insert-only / append-only = no UPDATE locks, maximum throughput
#   - Event-sourced model (every Start/Interim/Stop is an immutable row)
#   - Purpose-built columnar engine for time-series analytics
#   - Separation of concerns: PostgreSQL = relational, ClickHouse = analytical
#
# Session tracking for simultaneous-use control is handled by radutmp.
#######################################################################

#######################################################################
# Post-Auth Logging Queries
#######################################################################

post-auth {
        query = "\
                INSERT INTO ${..postauth_table} \
                        (username, pass, reply, authdate ${..class.column_name}) \
                VALUES(\
                        '%{User-Name}', \
                        '%{%{User-Password}:-%{Chap-Password}}', \
                        '%{reply:Packet-Type}', \
                        '%S.%M' \
                        ${..class.reply_xlat})"
}
