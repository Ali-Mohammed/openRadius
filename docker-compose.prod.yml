# =============================================================================
# OpenRadius - Enterprise Production Docker Compose
# =============================================================================
# Production-ready orchestration for OpenRadius application stack
# Includes: Frontend, Backend, PostgreSQL, Keycloak, Redis, Kafka/Redpanda
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:18.1
    container_name: openradius-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      POSTGRES_DB: openradius
    volumes:
      - postgres_data:/var/lib/postgresql
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    expose:
      - "5432"
    networks:
      - openradius-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d openradius"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"

  # ---------------------------------------------------------------------------
  # Keycloak - Identity & Access Management
  # ---------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:26.5
    container_name: openradius-keycloak
    restart: unless-stopped
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: admin
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_HOSTNAME: auth.${DOMAIN:-localhost}
      KC_HOSTNAME_STRICT: false
      KC_HTTP_ENABLED: true
      KC_PROXY: edge
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME_URL: https://auth.${DOMAIN:-localhost}
      KC_HOSTNAME_ADMIN_URL: https://auth.${DOMAIN:-localhost}
    expose:
      - "8080"
    networks:
      - openradius-network
    depends_on:
      postgres:
        condition: service_healthy
    command:
      - start-dev
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: 127.0.0.1\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

  # ---------------------------------------------------------------------------
  # Redis - Caching & Session Store
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: openradius-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123}
    expose:
      - "6379"
    volumes:
      - redis_data:/data
    networks:
      - openradius-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # Redpanda - Kafka-compatible Event Streaming
  # ---------------------------------------------------------------------------
  redpanda:
    image: redpandadata/redpanda:v25.3.4
    container_name: openradius-redpanda
    restart: unless-stopped
    command:
      - redpanda
      - start
      # Listeners: internal (plaintext, Docker-only) + external (SASL, internet-facing)
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://kafka.${DOMAIN:-localhost}:9094
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://redpanda:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --mode dev-container
      - --smp 1
      - --default-log-level=info
      # SASL/SCRAM authentication — external listener only
      # Internal listener stays plaintext for Debezium/Console within Docker network
      - --set redpanda.enable_sasl=true
      - --set redpanda.superusers=["admin"]
      - --set redpanda.kafka_api[0].authentication_method=none
      - --set redpanda.kafka_api[1].authentication_method=sasl
      # Bootstrap SCRAM superuser (created on first start)
      - --set redpanda.sasl_mechanisms=["SCRAM"]
    environment:
      # Bootstrap user — Redpanda creates this SCRAM user on first startup
      RP_BOOTSTRAP_USER: "admin:${KAFKA_SASL_PASSWORD:-changeme_in_production}"
    ports:
      - "9094:19092"  # Kafka external (SASL) — clients connect to kafka.<domain>:9094
    expose:
      - "18081"  # Schema Registry
      - "18082"  # Pandaproxy
      - "9644"   # Admin API
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    networks:
      - openradius-network
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5

  # ---------------------------------------------------------------------------
  # Redpanda Console - Kafka UI
  # ---------------------------------------------------------------------------
  redpanda-console:
    image: redpandadata/console:v3.4.0
    container_name: openradius-redpanda-console
    restart: unless-stopped
    entrypoint: /bin/sh
    command: -c 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml; /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
        login:
          enabled: true
          plain:
            enabled: true
            credentials:
              - username: admin
                password: ${REDPANDA_CONSOLE_PASSWORD:-changeme_in_production}
        enterprise:
          rbac:
            enabled: false
    expose:
      - "8080"
    networks:
      - openradius-network
    depends_on:
      redpanda:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # Debezium Connect - CDC Platform
  # ---------------------------------------------------------------------------
  debezium:
    image: debezium/connect:3.0.0.Final
    container_name: openradius-debezium
    restart: unless-stopped
    environment:
      BOOTSTRAP_SERVERS: redpanda:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: debezium_configs
      OFFSET_STORAGE_TOPIC: debezium_offsets
      STATUS_STORAGE_TOPIC: debezium_statuses
      # Single-node Redpanda: replication factor must be 1
      CONFIG_STORAGE_REPLICATION_FACTOR: 1
      OFFSET_STORAGE_REPLICATION_FACTOR: 1
      STATUS_STORAGE_REPLICATION_FACTOR: 1
      OFFSET_STORAGE_PARTITIONS: 1
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: true
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: true
    expose:
      - "8083"
    networks:
      - openradius-network
    depends_on:
      redpanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8083/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # Seq - Structured Log Server
  # ---------------------------------------------------------------------------
  seq:
    image: datalust/seq:2025.1
    container_name: openradius-seq
    restart: unless-stopped
    environment:
      ACCEPT_EULA: Y
    expose:
      - "80"
    volumes:
      - seq_data:/data
    networks:
      - openradius-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: openradius-nginx
    restart: unless-stopped
    entrypoint: ["/etc/nginx/docker-entrypoint.sh"]
    command: ["nginx", "-g", "daemon off;"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/docker-entrypoint.sh:/etc/nginx/docker-entrypoint.sh:ro
      - ./nginx/ssl:/etc/nginx/ssl
      - ./nginx/certbot:/var/www/certbot:ro
      - nginx_logs:/var/log/nginx
    networks:
      - openradius-network
    depends_on:
      - frontend
      - backend
      - keycloak
      - seq
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "80"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ---------------------------------------------------------------------------
  # OpenRadius Backend API
  # ---------------------------------------------------------------------------
  backend:
    image: alimohammed/openradius-backend:latest
    container_name: openradius-backend
    restart: unless-stopped
    pull_policy: always
    environment:
      # Database
      ConnectionStrings__MasterConnection: "Host=postgres;Port=5432;Database=openradius_master;Username=admin;Password=${POSTGRES_PASSWORD:-admin123}"
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=openradius;Username=admin;Password=${POSTGRES_PASSWORD:-admin123}"
      
      # OIDC/Keycloak
      # Authority & MetadataAddress use internal Docker URL (backend → keycloak within Docker network)
      Oidc__Authority: "${OIDC_AUTHORITY:-http://keycloak:8080/realms/openradius}"
      Oidc__MetadataAddress: "${OIDC_METADATA_ADDRESS:-http://keycloak:8080/realms/openradius/.well-known/openid-configuration}"
      # Issuer MUST match the 'iss' claim in tokens (the external URL Keycloak stamps on JWTs)
      Oidc__Issuer: "${OIDC_ISSUER:-https://auth.${DOMAIN:-localhost}/realms/openradius}"
      
      # Kafka
      Kafka__BootstrapServers: "redpanda:9092"
      
      # Debezium
      Debezium__ConnectUrl: "http://debezium:8083"
      
      # ASP.NET Core
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: "http://+:5000"
      
      # Host proc path for server monitoring (mounted at /host/proc)
      HOST_PROC_PATH: "/host/proc"
      
      # Seq Logging
      Seq__ServerUrl: "http://seq:80"
      Seq__ApiKey: "${SEQ_API_KEY:-}"
      
      # Switch Decryption (set your actual key)
      Switch__DecryptionKey: "${SWITCH_DECRYPTION_KEY:-YOUR_SWITCH_DECRYPTION_KEY_HEX}"
    expose:
      - "5000"
    networks:
      - openradius-network
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      redis:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    volumes:
      - backend_logs:/app/Logs
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /opt/openradius/docker-compose.prod.yml:/opt/openradius/docker-compose.prod.yml:ro
      - /opt/openradius/.env:/opt/openradius/.env:ro
    group_add:
      - "${DOCKER_GID:-999}"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ---------------------------------------------------------------------------
  # OpenRadius Frontend
  # ---------------------------------------------------------------------------
  frontend:
    image: alimohammed/openradius-frontend:latest
    container_name: openradius-frontend
    restart: unless-stopped
    pull_policy: always
    environment:
      DOMAIN: ${DOMAIN}
    expose:
      - "80"
    networks:
      - openradius-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

# =============================================================================
# Networks
# =============================================================================
networks:
  openradius-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  redpanda_data:
    driver: local
  backend_logs:
    driver: local
  seq_data:
    driver: local
  nginx_logs:
    driver: local
